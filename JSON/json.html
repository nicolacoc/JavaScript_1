<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JSON</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
</head>
<body>
<div class="container">



</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
<script>
    async function getAirQualityData(url){

        const response = await fetch(url);
        const status = response.ok;
        if (status){
            return await response.json();
        }
        throw new Error("Data not valid");
    }

    const promises = [
    getAirQualityData("https://data.sensor.community/airrohr/v1/sensor/50529/"),
    getAirQualityData("https://data.sensor.community/airrohr/v1/sensor/50550/")
]

    const p = Promise.all(promises);
    function GetMap(lat, lng){
        const key = "AIzaSyDiCScNSVT8dlgU-o8Iu0oxPTbs9Q4x9PM";
        return `<div class="map">
            <iframe
                width="450"
                height="250"
                frameBorder="0"
                style="border:0"
                referrerPolicy="no-referrer-when-downgrade"
                src="https://www.google.com/maps/embed/v1/view?key=${key}&center=${lat},${lng}&zoom=18&maptype=satellite"
                allowFullScreen>
            </iframe>
        </div>`

    }


    function PromiseToAirQualityData(promisesResult) {
        let data = [];
        promisesResult.forEach(singleResult => {
            if (singleResult instanceof Array){
                const location = singleResult[0].location;
                data.push({
                    Location: {
                        country: location.country,
                        long: location.longitude,
                        lat: location.latitude,
                        placeID: location.id,
                    },
                    DataSnapshot: singleResult.map(result =>{
                        const Values = [... result.sensordatavalues];
                        const timeStamp = result.timestamp;
                        return {
                            Values,
                            timeStamp
                        }
                    })
                })

            }
        })
        return data;
    }

    function getToPage(result){
        const cont = document.querySelector(".container");




        let tot = ``;

        for (let i= 0; i < result.length; i++) {
            const row = document.createElement("div");
            row.setAttribute("class", "row");
            let Location = result[i].Location;
            let lat = Location.lat;
            let lng = Location.long;
            let country= Location.country;
            let DataSnapshot = result[i].DataSnapshot;

            tot += `
        <div class="col">
            <h1>Air Quality:</h1>
            <div class="card" style="width: 450px;">
               ${GetMap(lat, lng)}
                <div class="card-body">
                    <h5 class="card-title">${country}</h5>
                </div>

                    <div class="card-body">

                          <div class="card mt-2">

                      <ul class="snapshot-data list-group list-group-flush">

                        `
            DataSnapshot.forEach(({Values, timeStamp}) =>{
                Values.forEach(({value_type, value}) => {
                    let Symbol1 = "";
                    if (value_type === "temperature"){Symbol1 = "°";}
                    tot+=`<li class="list-group-item d-flex">
                                <div class="row">
                                <div class="col me-5">${value_type}</div>
                                <div class="col">${value + Symbol1}</div>
                            </div>
                            </li>`
                })

                tot+=`
                        </ul>
                        <div class="card-body text-end">
                            <strong>${timeStamp}</strong>
                        </div>
                    `
            })

            tot+=`</div>
                </div>
            </div>
        </div>`
            i++;
            if (i < result.length) {
                Location = result[i].Location;
                lat = Location.lat;
                lng = Location.long;
                country= Location.country;
                DataSnapshot = result[i].DataSnapshot;


                tot += `
                    <div class="col">
                    <h1>Air Quality:</h1>
                <div class="card" style="width: 450px;">
                    ${GetMap(lat, lng)}
                    <div class="card-body">
                        <h5 class="card-title">${country}</h5>
                    </div>

                    <div class="card-body">

                        <div class="card mt-2">

                            <ul class="snapshot-data list-group list-group-flush">

                                `
                DataSnapshot.forEach(({Values, timeStamp}) =>{
                    Values.forEach(({value_type, value}) => {
                        let Symbol1 = "";
                        if (value_type=== "temperature"){Symbol1 = "°";}
                        tot+=`<li class="list-group-item d-flex">
                                          <div class="row">
                                <div class="col me-5">${value_type}</div>
                                <div class="col">${value + Symbol1}</div>
                            </div>
                            </li>`
                    })

                    tot+=`
                        </ul>
                        <div class="card-body text-end">
                            <strong>${timeStamp}</strong>
                        </div>
                    `
                })

                tot+=`</div>
                    </div>
                </div>
            </div>`
            }
            row.innerHTML= tot;
            cont.append(row);

        }






    }

    p.then(PromiseToAirQualityData).then(getToPage)





</script>
</body>
</html>