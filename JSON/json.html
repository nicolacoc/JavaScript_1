<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JSON</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
</head>
<body>
<div class="container">



</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>



<script>



    async function getAirQualityData(url){

        const response = await fetch(url);
        const status = response.ok;
        if (status){
            return await response.json();
        }
        throw new Error("Data not valid");
    }


    async function FetchLocation(lat,lng){

        const response = await fetch(`https://nominatim.openstreetmap.org/reverse.php?lat=${lat}&lon=${lng}&zoom=18&format=jsonv2`);
        const status = response.ok;
        if (status){
            return await response.json();

        }
        throw new Error("Data not valid");
    }



    const promises = [
    getAirQualityData("https://data.sensor.community/airrohr/v1/sensor/77350/"),
    getAirQualityData("https://data.sensor.community/airrohr/v1/sensor/50530/")
]

    const p = Promise.all(promises);
    function GetMap(lat, lng){
        const key = "AIzaSyDiCScNSVT8dlgU-o8Iu0oxPTbs9Q4x9PM";
        return `<div class="map">
            <iframe
                width="450"
                height="250"
                frameBorder="0"
                style="border:0"
                referrerPolicy="no-referrer-when-downgrade"
                src="https://www.google.com/maps/embed/v1/view?key=${key}&center=${lat},${lng}&zoom=18&maptype=satellite"
                allowFullScreen>
            </iframe>
        </div>`

    }

    function PromiseToAirQualityData(promisesResult) {
        let data = [];
        const promisesLocation= [];
        promisesResult.forEach((singleResult) => {
            if (singleResult instanceof Array && singleResult.length > 0){
                let location = singleResult[0].location;
                let long = Number.parseFloat(location.longitude);
                let lat = Number.parseFloat(location.latitude);
                let placeID = location.id;

                if (isNaN(placeID)){
                    throw new Error("Place id non è un numero!!")
                }
                if (isNaN(long)||isNaN(lat)){
                    throw new Error("Long o Lat non è un numero!!");
                }

                promisesLocation.push(FetchLocation(lat, long))


                    data.push({
                        Location: {
                            long: long,
                            lat: lat,
                            placeID: placeID,
                        },
                        DataSnapshot: singleResult.map(result => {
                            const Values = [...result.sensordatavalues];
                            const timeStamp = result.timestamp;
                            return {
                                Values,
                                timeStamp
                            }
                        })
                    })




            }
        })
        return {data, promisesLocation};
    }

    async function getResult({data, promisesLocation}){
        let result1= [... data];
        let result2= await Promise.all(promisesLocation);
        let location = [];
            result2.forEach((result4)=>{
                let address = result4.address;
                let country =  address.country;
                let city =  address.city;
                if (typeof city === "undefined"){
                    city = address.town;
                }
                location.push({country, city})



        })
        return {result1, location}
    }

    function getToPage({result1, location}){
        const cont = document.querySelector(".container");

        let tot = ``;

        for (let i= 0; i < result1.length; i++) {
            const row = document.createElement("div");
            row.setAttribute("class", "row");
            let Location2 = result1[i].Location;
            let lat = Location2.lat;
            let lng = Location2.long;
            let country= location[i].country;
            let city = location[i].city;
            let DataSnapshot = result1[i].DataSnapshot;
            tot += `
        <div class="col">
            <h1>Air Quality:</h1>
            <div class="card" style="width: 450px;">
               ${GetMap(lat, lng)}
                <div class="card-body">
                    <h5 class="card-title">${city} (${country})</h5>
                </div>

                    <div class="card-body">

                          <div class="card mt-2">

                      <ul class="snapshot-data list-group list-group-flush">

                        `
            DataSnapshot.forEach(({Values, timeStamp}) =>{
                Values.forEach(({value_type, value}) => {
                    let Symbol1 = "";
                    if (value_type === "temperature"){Symbol1 = "°";}
                    tot+=`<li class="list-group-item d-flex">
                                <div class="row">
                                <div class="col me-5">${value_type}</div>
                                <div class="col">${value + Symbol1}</div>
                            </div>
                            </li>`
                })

                tot+=`
                        </ul>
                        <div class="card-body text-end">
                            <strong>${timeStamp}</strong>
                        </div>
                    `
            })

            tot+=`</div>
                </div>
            </div>
        </div>`
            i++;
            if (i < result1.length) {
                Location2 = result1[i].Location;
                lat = Location2.lat;
                lng = Location2.long;


                country= location[i].country;
                city = location[i].city;
                DataSnapshot = result1[i].DataSnapshot;
                tot += `
        <div class="col">
            <h1>Air Quality:</h1>
            <div class="card" style="width: 450px;">
               ${GetMap(lat, lng)}
                <div class="card-body">
                    <h5 class="card-title">${city} (${country})</h5>
                </div>

                    <div class="card-body">

                          <div class="card mt-2">

                      <ul class="snapshot-data list-group list-group-flush">

                        `
                DataSnapshot.forEach(({Values, timeStamp}) =>{
                    Values.forEach(({value_type, value}) => {
                        let Symbol1 = "";
                        if (value_type === "temperature"){Symbol1 = "°";}
                        tot+=`<li class="list-group-item d-flex">
                                <div class="row">
                                <div class="col me-5">${value_type}</div>
                                <div class="col">${value + Symbol1}</div>
                            </div>
                            </li>`
                    })

                    tot+=`
                        </ul>
                        <div class="card-body text-end">
                            <strong>${timeStamp}</strong>
                        </div>
                    `


                })

                tot+=`</div>
                    </div>
                </div>
            </div>`
            }
            row.innerHTML= tot;
            cont.append(row);

        }






    }


p.then(PromiseToAirQualityData).then(getResult).then(getToPage)



</script>
</body>
</html>